<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OurRoom</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --bg: #f0f2f5;
            --panel: #ffffff;
            --text: #333;
            --primary: #007bff;
            --accent: #0056b3;
            --border: #ccc;
        }

        /* Theme Classes */
        body.theme-vibrant { --bg: #FF9A9E; --panel: #FECFEF; --text: #333; --primary: #FF6B6B; }
        body.theme-neon { --bg: #000000; --panel: #1a1a1a; --text: #0ff; --primary: #f0f; --border: #333; }
        body.theme-romantic { --bg: #ffe6e6; --panel: #fff0f0; --text: #5c2a2a; --primary: #ff4d4d; }
        body.theme-black { --bg: #121212; --panel: #1e1e1e; --text: #e0e0e0; --primary: #bb86fc; --border: #333; }
        body.theme-green { --bg: #e8f5e9; --panel: #c8e6c9; --text: #1b5e20; --primary: #43a047; }
        body.theme-sky { --bg: #e3f2fd; --panel: #bbdefb; --text: #0d47a1; --primary: #2196f3; }

        * { box-sizing: border-box; tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; transition: 0.3s; }

        /* --- STARTUP POPUP --- */
        #start-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8);
            z-index: 9999; display: flex; justify-content: center; align-items: center;
        }
        .modal-box {
            background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 400px;
            text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .modal-box input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; }
        .modal-box button { width: 100%; padding: 10px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; }

        /* --- HEADER --- */
        #header {
            height: 60px; background: var(--panel); border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; padding: 0 15px; z-index: 100;
        }
        #room-title { font-weight: bold; font-size: 1.2rem; }
        .controls { display: flex; gap: 10px; }
        .btn-icon { background: none; border: none; font-size: 1.2rem; color: var(--text); cursor: pointer; padding: 5px; }
        .btn-icon:hover { opacity: 0.7; }

        /* --- MAIN STAGE (Youtube / Whiteboard) --- */
        #main-stage {
            flex: 1; position: relative; background: #000; overflow: hidden; display: flex; justify-content: center; align-items: center;
        }
        
        /* YouTube Layer */
        #yt-container { width: 100%; height: 100%; display: none; }
        #yt-input-bar {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); padding: 5px; border-radius: 8px; z-index: 10; display: flex; gap: 5px;
        }
        
        /* Whiteboard Layer */
        #wb-container { width: 100%; height: 100%; background: white; display: none; position: relative; }
        #wb-toolbar {
            position: absolute; top: 10px; left: 10px; background: #f0f0f0; border: 1px solid #ccc;
            padding: 5px; border-radius: 8px; display: flex; flex-direction: column; gap: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .tool-row { display: flex; gap: 5px; flex-wrap: wrap; }
        .wb-btn { width: 30px; height: 30px; border: 1px solid #ccc; background: white; cursor: pointer; display: flex; justify-content: center; align-items: center; border-radius: 4px; }
        .wb-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* --- FLOATING VIDEO BUBBLES --- */
        #video-overlay {
            position: absolute; top: 70px; right: 10px; width: 150px; display: flex; flex-direction: column; gap: 10px; z-index: 200;
        }
        .video-card {
            width: 150px; height: 100px; background: #333; border-radius: 10px; overflow: hidden;
            position: relative; border: 2px solid var(--panel); box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: height 0.3s;
        }
        .video-card video { width: 100%; height: 100%; object-fit: cover; }
        .vid-controls {
            position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.6);
            padding: 2px 5px; display: flex; justify-content: space-between; align-items: center;
        }
        .vid-controls span { color: white; font-size: 0.7rem; }
        .mini-btn { color: white; cursor: pointer; font-size: 0.8rem; margin-left: 5px; }

        /* Minimized State */
        .video-card.minimized { height: 30px; }
        .video-card.minimized video { display: none; }

        /* --- BOTTOM CHAT PANEL --- */
        #chat-panel {
            height: 50%; background: var(--panel); border-top: 2px solid var(--border);
            display: flex; flex-direction: column; transition: height 0.3s; z-index: 150;
        }
        #chat-panel.minimized { height: 40px; }

        .chat-header {
            padding: 8px 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.05); cursor: pointer;
        }
        .chat-tabs { display: flex; gap: 15px; }
        .tab { cursor: pointer; padding-bottom: 2px; font-weight: bold; opacity: 0.6; }
        .tab.active { border-bottom: 2px solid var(--primary); color: var(--primary); opacity: 1; }
        
        .chat-body { flex: 1; position: relative; overflow: hidden; display: none; }
        .chat-body.active { display: flex; flex-direction: column; }
        
        .messages { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 8px 12px; border-radius: 12px; font-size: 0.9rem; max-width: 80%; word-wrap: break-word; }
        .msg.sent { align-self: flex-end; background: var(--primary); color: white; }
        .msg.received { align-self: flex-start; background: rgba(0,0,0,0.1); color: var(--text); }
        
        .input-area { padding: 10px; border-top: 1px solid var(--border); display: flex; gap: 5px; }
        .input-area input { flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 20px; outline: none; background: rgba(255,255,255,0.8); }

        /* Theme Dropdown */
        #theme-menu {
            position: absolute; top: 50px; right: 60px; background: white; border: 1px solid #ccc;
            border-radius: 8px; padding: 5px; display: none; flex-direction: column; gap: 5px; z-index: 300;
        }
        .theme-opt { padding: 5px 10px; cursor: pointer; font-size: 0.9rem; border-radius: 4px; color: black; }
        .theme-opt:hover { background: #eee; }

    </style>
</head>
<body>

    <div id="start-modal">
        <div class="modal-box">
            <h2>Welcome</h2>
            <input type="text" id="start-name" placeholder="Enter Your Name">
            <input type="text" id="start-room" placeholder="Room Name (Optional)">
            <button onclick="enterApp()">Enter Room</button>
        </div>
    </div>

    <div id="header">
        <div id="room-title">Ourroom.netlify.app</div>
        <div class="controls">
            <button class="btn-icon" onclick="toggleThemeMenu()" title="Themes"><i class="fas fa-palette"></i></button>
            <button class="btn-icon" onclick="switchStage('yt')" title="YouTube"><i class="fab fa-youtube"></i></button>
            <button class="btn-icon" onclick="switchStage('wb')" title="Whiteboard"><i class="fas fa-paint-brush"></i></button>
            <button class="btn-icon" onclick="shareScreen()" title="Screen Share"><i class="fas fa-desktop"></i></button>
            <button class="btn-icon" onclick="copyLink()" title="Invite"><i class="fas fa-link"></i></button>
        </div>
        <div id="theme-menu">
            <div class="theme-opt" onclick="setTheme('vibrant')">üå∏ Vibrant</div>
            <div class="theme-opt" onclick="setTheme('neon')">üåÉ Neon</div>
            <div class="theme-opt" onclick="setTheme('romantic')">‚ù§Ô∏è Romantic</div>
            <div class="theme-opt" onclick="setTheme('black')">‚ö´ Black</div>
            <div class="theme-opt" onclick="setTheme('green')">üåø Green</div>
            <div class="theme-opt" onclick="setTheme('sky')">‚òÅÔ∏è Sky Blue</div>
        </div>
    </div>

    <div id="video-overlay">
        <div class="video-card" id="card-local">
            <div class="vid-controls">
                <span>Me</span>
                <div>
                    <i class="fas fa-microphone-slash mini-btn" onclick="toggleMute('local')"></i>
                    <i class="fas fa-compress-arrows-alt mini-btn" onclick="toggleMin('card-local')"></i>
                </div>
            </div>
            <video id="local-video" autoplay muted playsinline></video>
        </div>
        <div class="video-card" id="card-remote">
            <div class="vid-controls">
                <span id="remote-label">Guest</span>
                <div>
                    <i class="fas fa-volume-mute mini-btn" onclick="toggleMute('remote')"></i>
                    <i class="fas fa-compress-arrows-alt mini-btn" onclick="toggleMin('card-remote')"></i>
                </div>
            </div>
            <video id="remote-video" autoplay playsinline></video>
        </div>
    </div>

    <div id="main-stage">
        <div id="stage-placeholder" style="color:white; text-align:center;">
            <h3>Waiting for activity...</h3>
            <p>Select YouTube or Paint from the header.</p>
        </div>

        <div id="yt-container">
            <div id="yt-input-bar">
                <input type="text" id="yt-url" placeholder="Video ID or URL" style="border:none; border-radius:4px; padding:5px;">
                <button onclick="loadYT()">Play</button>
            </div>
            <div id="player"></div>
        </div>

        <div id="wb-container">
            <canvas id="wb-canvas"></canvas>
            <div id="wb-toolbar">
                <div class="tool-row">
                    <div class="wb-btn active" onclick="wbTool='pen'" title="Pen"><i class="fas fa-pen"></i></div>
                    <div class="wb-btn" onclick="wbTool='eraser'" title="Eraser"><i class="fas fa-eraser"></i></div>
                    <div class="wb-btn" onclick="clearWB()"><i class="fas fa-trash"></i></div>
                </div>
                <div class="tool-row">
                    <div class="wb-btn" onclick="wbTool='rect'"><i class="far fa-square"></i></div>
                    <div class="wb-btn" onclick="wbTool='circle'"><i class="far fa-circle"></i></div>
                </div>
                <input type="color" id="wb-color" value="#000000" onchange="wbColor=this.value">
                <input type="range" id="wb-size" min="1" max="20" value="3" onchange="wbSize=this.value">
            </div>
        </div>
    </div>

    <div id="chat-panel">
        <div class="chat-header">
            <div class="chat-tabs">
                <div class="tab active" onclick="switchChat('live')" id="tab-live">Live Chat</div>
                <div class="tab" onclick="switchChat('saved')" id="tab-saved">Saved Chat</div>
            </div>
            <i class="fas fa-chevron-down" onclick="toggleChatPanel()"></i>
        </div>

        <div class="chat-body active" id="body-live">
            <div class="messages" id="msgs-live">
                <div style="text-align:center; color:#888; font-size:0.8rem;">Temporary Room Chat</div>
            </div>
            <div class="input-area">
                <input type="text" id="in-live" placeholder="Message room..." onkeypress="if(event.key==='Enter') sendLive()">
                <button class="btn-icon" onclick="sendLive()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <div class="chat-body" id="body-saved">
            <div class="messages" id="msgs-saved"></div>
            <div class="input-area">
                <input type="text" id="in-saved" placeholder="Personal notes..." onkeypress="if(event.key==='Enter') saveNote()">
                <button class="btn-icon" onclick="saveNote()"><i class="fas fa-save"></i></button>
            </div>
        </div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        // --- STATE & VARS ---
        const peer = new Peer();
        let conn, call, localStream;
        let myName = "User";
        let roomName = "Ourroom.netlify.app";

        // --- STARTUP LOGIC ---
        function enterApp() {
            const n = document.getElementById('start-name').value;
            const r = document.getElementById('start-room').value;
            if(n) myName = n;
            if(r) roomName = r;
            
            document.getElementById('room-title').innerText = roomName;
            document.getElementById('start-modal').style.display = 'none';
            
            initMedia();
            loadSavedChat();
        }

        // --- PEERJS / MEDIA ---
        function initMedia() {
            navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
                localStream = stream;
                document.getElementById('local-video').srcObject = stream;

                peer.on('open', id => {
                    const urlParams = new URLSearchParams(window.location.search);
                    const hostId = urlParams.get('host');
                    if (hostId) connectToHost(hostId);
                });

                peer.on('call', incoming => {
                    incoming.answer(stream);
                    handleCall(incoming);
                });

                peer.on('connection', c => {
                    conn = c;
                    setupDataConnection();
                });
            });
        }

        function connectToHost(id) {
            conn = peer.connect(id);
            const outgoing = peer.call(id, localStream);
            handleCall(outgoing);
            setupDataConnection();
        }

        function handleCall(c) {
            call = c;
            c.on('stream', s => document.getElementById('remote-video').srcObject = s);
        }

        function setupDataConnection() {
            conn.on('open', () => {
                sendData({ type: 'info', name: myName });
                // Sync Theme on connect
                sendData({ type: 'theme', theme: document.body.className });
            });
            conn.on('data', data => handleData(data));
        }

        function sendData(obj) { if(conn && conn.open) conn.send(obj); }

        function handleData(d) {
            switch(d.type) {
                case 'info': document.getElementById('remote-label').innerText = d.name; break;
                case 'chat': appendMsg('live', d.msg, 'received'); break;
                case 'theme': applyTheme(d.theme, false); break;
                case 'yt': handleYTSync(d); break;
                case 'draw': handleDraw(d); break;
                case 'stage': switchStage(d.view, false); break;
            }
        }

        // --- UI ACTIONS ---
        function toggleMin(id) { document.getElementById(id).classList.toggle('minimized'); }
        function toggleChatPanel() { document.getElementById('chat-panel').classList.toggle('minimized'); }
        function copyLink() {
            const url = window.location.href.split('?')[0] + '?host=' + peer.id;
            navigator.clipboard.writeText(url);
            alert("Invite link copied!");
        }
        function toggleMute(who) {
            if(who === 'local') {
                localStream.getAudioTracks()[0].enabled = !localStream.getAudioTracks()[0].enabled;
            } else {
                document.getElementById('remote-video').muted = !document.getElementById('remote-video').muted;
            }
        }
        async function shareScreen() {
            try {
                const s = await navigator.mediaDevices.getDisplayMedia({video:true});
                const sender = call.peerConnection.getSenders().find(s => s.track.kind === 'video');
                sender.replaceTrack(s.getVideoTracks()[0]);
                document.getElementById('local-video').srcObject = s;
                s.getVideoTracks()[0].onended = () => { /* Logic to revert */ };
            } catch(e) {}
        }

        // --- THEMES ---
        function toggleThemeMenu() { 
            const m = document.getElementById('theme-menu');
            m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
        }
        function setTheme(name) {
            applyTheme('theme-' + name, true);
        }
        function applyTheme(cls, broadcast) {
            document.body.className = cls;
            document.getElementById('theme-menu').style.display = 'none';
            if(broadcast) sendData({ type: 'theme', theme: cls });
        }

        // --- CHAT SYSTEM ---
        function switchChat(type) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.chat-body').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-'+type).classList.add('active');
            document.getElementById('body-'+type).classList.add('active');
        }

        function appendMsg(type, txt, cls) {
            const div = document.createElement('div');
            div.className = `msg ${cls}`;
            div.innerText = txt;
            document.getElementById(`msgs-${type}`).appendChild(div);
            // Auto scroll
            document.getElementById(`msgs-${type}`).scrollTop = document.getElementById(`msgs-${type}`).scrollHeight;
        }

        function sendLive() {
            const input = document.getElementById('in-live');
            const txt = input.value.trim();
            if(!txt) return;
            appendMsg('live', txt, 'sent');
            sendData({ type: 'chat', msg: txt });
            input.value = '';
        }

        function saveNote() {
            const input = document.getElementById('in-saved');
            const txt = input.value.trim();
            if(!txt) return;
            appendMsg('saved', txt, 'sent'); // Visual only for user
            
            // Save to LocalStorage
            let history = JSON.parse(localStorage.getItem('my_notes') || '[]');
            history.push({ txt: txt, date: new Date().toLocaleString() });
            localStorage.setItem('my_notes', JSON.stringify(history));
            input.value = '';
        }

        function loadSavedChat() {
            let history = JSON.parse(localStorage.getItem('my_notes') || '[]');
            history.forEach(h => appendMsg('saved', `${h.date}: ${h.txt}`, 'received'));
        }

        // --- STAGE SWITCHER ---
        function switchStage(view, broadcast = true) {
            document.getElementById('stage-placeholder').style.display = 'none';
            document.getElementById('yt-container').style.display = (view === 'yt') ? 'block' : 'none';
            document.getElementById('wb-container').style.display = (view === 'wb') ? 'block' : 'none';
            if(view === 'wb') resizeCanvas();
            if(broadcast) sendData({ type: 'stage', view: view });
        }

        // --- YOUTUBE SYNC ---
        let player;
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%', width: '100%',
                playerVars: { 'autoplay': 0, 'controls': 1 },
                events: { 'onStateChange': onPlayerStateChange }
            });
        }
        function loadYT() {
            const val = document.getElementById('yt-url').value;
            let id = val.split('v=')[1] || val.split('/').pop();
            if(id) {
                player.loadVideoById(id);
                sendData({ type: 'yt', action: 'load', id: id });
            }
        }
        function onPlayerStateChange(event) {
            // 1=playing, 2=paused
            if(event.data === 1) sendData({ type: 'yt', action: 'play', time: player.getCurrentTime() });
            if(event.data === 2) sendData({ type: 'yt', action: 'pause' });
        }
        function handleYTSync(d) {
            if(!player || !player.loadVideoById) return;
            if(d.action === 'load') player.loadVideoById(d.id);
            if(d.action === 'play') {
                if(Math.abs(player.getCurrentTime() - d.time) > 1) player.seekTo(d.time);
                player.playVideo();
            }
            if(d.action === 'pause') player.pauseVideo();
        }

        // --- WHITEBOARD (PAINT) ---
        const canvas = document.getElementById('wb-canvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let wbTool = 'pen';
        let wbColor = '#000000';
        let wbSize = 3;
        let lastX = 0, lastY = 0;

        function resizeCanvas() {
            canvas.width = canvas.parentElement.offsetWidth;
            canvas.height = canvas.parentElement.offsetHeight;
            ctx.lineCap = 'round';
        }

        canvas.addEventListener('mousedown', startDraw);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDraw);
        canvas.addEventListener('mouseout', stopDraw);
        
        // Touch support
        canvas.addEventListener('touchstart', e => {
             const t = e.touches[0];
             startDraw({ offsetX: t.clientX - canvas.getBoundingClientRect().left, offsetY: t.clientY - canvas.getBoundingClientRect().top });
        });
        canvas.addEventListener('touchmove', e => {
            e.preventDefault();
            const t = e.touches[0];
            draw({ offsetX: t.clientX - canvas.getBoundingClientRect().left, offsetY: t.clientY - canvas.getBoundingClientRect().top });
        });
        canvas.addEventListener('touchend', stopDraw);

        function startDraw(e) {
            isDrawing = true;
            [lastX, lastY] = [e.offsetX, e.offsetY];
        }

        function draw(e) {
            if (!isDrawing) return;
            
            if(wbTool === 'pen' || wbTool === 'eraser') {
                ctx.strokeStyle = (wbTool === 'eraser') ? '#ffffff' : wbColor;
                ctx.lineWidth = wbSize;
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(e.offsetX, e.offsetY);
                ctx.stroke();

                sendData({
                    type: 'draw', tool: wbTool, 
                    x0: lastX/canvas.width, y0: lastY/canvas.height, 
                    x1: e.offsetX/canvas.width, y1: e.offsetY/canvas.height,
                    color: wbColor, size: wbSize
                });
                
                [lastX, lastY] = [e.offsetX, e.offsetY];
            }
        }

        function stopDraw() { isDrawing = false; ctx.beginPath(); }
        function clearWB() { 
            ctx.clearRect(0,0,canvas.width, canvas.height); 
            sendData({ type: 'draw', tool: 'clear' });
        }

        function handleDraw(d) {
            const w = canvas.width;
            const h = canvas.height;
            if(d.tool === 'clear') {
                ctx.clearRect(0,0,w,h);
            } else {
                ctx.strokeStyle = (d.tool === 'eraser') ? '#ffffff' : d.color;
                ctx.lineWidth = d.size;
                ctx.beginPath();
                ctx.moveTo(d.x0 * w, d.y0 * h);
                ctx.lineTo(d.x1 * w, d.y1 * h);
                ctx.stroke();
            }
        }
    </script>
</body>
</html>
